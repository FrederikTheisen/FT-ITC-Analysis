// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using AppKit;
using AnalysisITC.GUI.MacOS.CustomViews;
using CoreGraphics;
using AnalysisITC.AppClasses.AnalysisClasses;
using System.Collections.Generic;
using System.Linq;

namespace AnalysisITC
{
    public partial class ExperimentDetailsPopoverController : NSViewController
    {
        public static event EventHandler UpdateTable; 

        public static ExperimentData Data { get; set; } = null;
        static List<ExperimentAttribute> tmpoptions = new List<ExperimentAttribute>();
        public static IEnumerable<AttributeKey> AllAddedOptions => Data.Attributes.Select(opt => opt.Key).Concat(tmpoptions.Select(mo => mo.Key).ToList());
        public static IEnumerable<AttributeKey> AvailableAttributes => tmpoptions.Select(mo => mo.Key).ToList();


        public ExperimentDetailsPopoverController() : base()
        {

        }

		public ExperimentDetailsPopoverController (IntPtr handle) : base (handle)
		{
		}

        public override void ViewDidAppear()
        {
            base.ViewDidAppear();

            tmpoptions = new List<ExperimentAttribute>();
            foreach (var att in Data.Attributes)
            {
                tmpoptions.Add(att.Copy());
            }

            Setup();
        }

        void Setup()
        {
            ExperimentNameField.StringValue = Data.FileName;
            CellConcentrationField.DoubleValue = Data.CellConcentration.Value * 1000000;
            if (Data.CellConcentration.HasError) CellConcentrationErrorField.DoubleValue = Data.CellConcentration.SD * 1000000;
            SyringeConcentrationField.DoubleValue = Data.SyringeConcentration * 1000000;
            if (Data.SyringeConcentration.HasError) SyringeConcentrationErrorField.DoubleValue = Data.SyringeConcentration.SD * 1000000;
            TemperatureField.DoubleValue = Data.MeasuredTemperature;
            CommentTextField.StringValue = Data.Comments;

            foreach (var opt in tmpoptions)
            {
                AddAttribute(opt);
            }

            // For tandem/merged experiments, we do not allow changing the concentrations
            if (Data.IsTandemExperiment)
            {
                CellConcentrationField.Enabled = false;
                CellConcentrationErrorField.Enabled = false;
                SyringeConcentrationField.Enabled = false;
                SyringeConcentrationErrorField.Enabled = false;
            }
        }

        partial void AddAttribute(NSObject sender)
        {
            var opt = new ExperimentAttribute();
            tmpoptions.Add(opt);
            AddAttribute(opt);
        }

        void AddAttribute(ExperimentAttribute opt)
        {
            var sv = new ExperimentAttributeView(new CGRect(0, 0, AttributeStackView.Frame.Width - 20, 14), opt);
            sv.Remove += Sv_Remove;
            sv.KeyChanged += Sv_KeyChanged;
            sv.SpecialAttributeSelected += Sv_SpecialAttributeSelected;

            AttributeStackView.AddArrangedSubview(sv);

            //Obsolete and wrong//if (AttributeStackView.Subviews.Count() == ModelOptions.AvailableExperimentAttributes.Count) AddAttributeButton.Enabled = false;
        }

        private void Sv_SpecialAttributeSelected(object sender, Tuple<AttributeKey, int> e)
        {
            switch (e.Item1)
            {
                case AttributeKey.Buffer:
                    BufferAttribute.SetupSpecialBuffer(tmpoptions, (Buffer)e.Item2);
                    break;
            }

            AttributeStackView.Subviews = new NSView[0];

            foreach (var opt in tmpoptions) AddAttribute(opt);
        }

        private void Sv_KeyChanged(object sender, EventArgs e) //Update available menu items
        {
            foreach (var sv in AttributeStackView.Views)
            {
                (sv as ExperimentAttributeView).UpdateKeyMenu();
            }
        }

        private void Sv_Remove(object sender, EventArgs e)
        {
            AttributeStackView.RemoveView(sender as NSView);
            AttributeStackView.Layout();

            tmpoptions.Remove((sender as ExperimentAttributeView).Option);

            if (AttributeStackView.Subviews.Count() < ExperimentAttribute.AvailableExperimentAttributes.Count) AddAttributeButton.Enabled = true;

            Sv_KeyChanged(null, null);
        }

        partial void Apply(NSObject sender)
        {
            // Outer scope try catch just in case
            try
            {
                if (!string.IsNullOrEmpty(SyringeConcentrationField.StringValue)) Data.SyringeConcentration = new(SyringeConcentrationField.DoubleValue / 1000000, SyringeConcentrationErrorField.DoubleValue / 1000000);
                if (!string.IsNullOrEmpty(CellConcentrationField.StringValue)) Data.CellConcentration = new(CellConcentrationField.DoubleValue / 1000000, CellConcentrationErrorField.DoubleValue / 1000000);
                if (!string.IsNullOrEmpty(TemperatureField.StringValue)) Data.MeasuredTemperature = TemperatureField.DoubleValue;
                if (!string.IsNullOrEmpty(ExperimentNameField.StringValue)) Data.FileName = ExperimentNameField.StringValue;

                Data.Attributes.Clear();

                foreach (var sv in AttributeStackView.Subviews)
                {
                    // Try catch that should not delete other attributes of one fails
                    try
                    {
                        (sv as ExperimentAttributeView).ApplyOption(Data);
                    }
                    catch (Exception ex)
                    {
                        AppEventHandler.DisplayHandledException(ex);
                    }
                }

                DataReaders.RawDataReader.ProcessInjections(Data);

                // Ensure reference experiment is subtracted immediately
                var proc = new DataProcessor(Data);
                proc.IntegratePeaks();

                Data.Comments = CommentTextField.StringValue;

                DismissViewController(this);

                UpdateTable?.Invoke(this, null);
            }
            catch (Exception ex)
            {
                AppEventHandler.DisplayHandledException(ex);
            }
        }

        partial void Cancel(NSObject sender)
        {
            DismissViewController(this);
        }
    }
}
