// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using AppKit;
using System.Collections.Generic;
using System.Linq;

namespace AnalysisITC
{
	public partial class BufferSubtractionTool : NSViewController
	{
        ExperimentMergeQueueDataSource mergeSource;
        ExperimentMergeQueueDelegate mergeDelegate;

        public BufferSubtractionTool (IntPtr handle) : base (handle)
		{
		}

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();

            mergeSource = new ExperimentMergeQueueDataSource();
            mergeSource.SetFromOpenExperiments(defaultActiveFromInclude: false); // uses DataManager.Data / Include :contentReference[oaicite:5]{index=5}

            mergeDelegate = new ExperimentMergeQueueDelegate(mergeSource);
            mergeDelegate.SelectionChanged += (_, __) =>
            {
                ValidateApplyButton();
            };

            SelectListView.DataSource = mergeSource;
            SelectListView.Delegate = mergeDelegate;
            SelectListView.ReloadData();

            PopulateReferencePopup();
            ValidateApplyButton();
        }

        void PopulateReferencePopup()
        {
            ReferenceExperimentSelection.RemoveAllItems();

            // Optional: add a placeholder first item
            ReferenceExperimentSelection.AddItem("Select buffer experiment…");
            ReferenceExperimentSelection.Menu.ItemAt(0).Enabled = false;

            foreach (var exp in DataManager.Data)
            {
                var title = $"{exp.FileName} — {exp.Date:HH:mm}";
                ReferenceExperimentSelection.AddItem(title);
            }

            // Default selection (first real item if exists)
            //if (ReferenceExperimentSelection.Menu.Count > 0)
            //    ReferenceExperimentSelection.SelectItem(1);
        }

        partial void ReferenceSelectionChanged(NSPopUpButton sender)
        {
            //ReferenceExperimentSelection.ItemAtIndex(0).Title = "test";

            var reference = GetSelectedReference();

            string info = "";

            if (reference != null)
            {
                info = "Experiment: " + reference.FileName + Environment.NewLine;
                info += "Date: " + reference.UILongDateWithTime + Environment.NewLine;
                info += "Details: " + reference.MeasuredTemperature.ToString("G3") + " °C | [syringe] = " + reference.SyringeConcentration.AsFormattedConcentration(true) + " | [cell] = " + reference.CellConcentration.AsFormattedConcentration(true) + Environment.NewLine;
                if (!string.IsNullOrEmpty(reference.Comments)) info += "Comments: " + reference.Comments;
                if (reference.Processor == null || !reference.Processor.IntegrationCompleted) info += Environment.NewLine + "NOT YET PROCESSED";
            }

            ReferenceExperimentInfoLabel.StringValue = info;

            ValidateApplyButton();
        }

        ExperimentData GetSelectedReference()
        {
            // If you used the placeholder, subtract 1
            var idx = (int)ReferenceExperimentSelection.IndexOfSelectedItem - 1;
            if (idx < 0 || idx >= DataManager.Data.Count) return null;
            return DataManager.Data[idx];
        }

        List<ExperimentData> CaptureSelectedIDs(NSTableView tableView, ExperimentMergeQueueDataSource source)
        {
            var ids = new List<ExperimentData>();
            var idx = tableView.SelectedRows;

            idx.EnumerateIndexes((nuint i, ref bool stop) =>
            {
                if (i < (nuint)source.Items.Count)
                    ids.Add(source.Items[(int)i].Data);
            });

            return ids;
        }

        void ValidateApplyButton()
        {
            var reference = GetSelectedReference();
            var targets = CaptureSelectedIDs(SelectListView, mergeSource);

            ApplyButton.Enabled = (reference != null && targets.Where(t => t != reference).Count() > 0);
        }

        partial void Apply(NSObject sender)
        {
            try
            {
                var reference = GetSelectedReference();
                var targets = CaptureSelectedIDs(SelectListView, mergeSource);

                foreach (var target in targets)
                {
                    if (target == reference) continue;

                    AppEventHandler.PrintAndLog($"Adding buffer reference ({reference.FileName}) to {target.FileName}");

                    target.SetReferenceExperiment(reference);
                }

                DismissViewController(this);
            }
            catch (Exception ex)
            {
                AppEventHandler.DisplayHandledException(ex);
            }
        }
    }
}
