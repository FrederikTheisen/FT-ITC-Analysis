// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using AppKit;
using static AnalysisITC.AppClasses.Analysis2.Models.SolutionInterface;

namespace AnalysisITC
{
	public partial class ExportPreferencesViewController : NSViewController
	{
        public static void ApplySettings() => ShouldApplySettings?.Invoke(null, null);
        public static event EventHandler ShouldApplySettings;

        public ExportPreferencesViewController (IntPtr handle) : base (handle)
		{
            ShouldApplySettings += ExportPreferencesViewController_ShouldApplySettings;
		}

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();

            ExportSelectedControl.SelectedSegment = (int)AppSettings.ExportSelectionMode;
            UnifyAxesControl.SelectedSegment = AppSettings.UnifyTimeAxisForExport ? 0 : 1;
            ExportSolutionPointsControl.State = AppSettings.ExportFitPointsWithPeaks ? NSCellStateValue.On : NSCellStateValue.Off;

            FinalFigHeightField.StringValue = AppSettings.FinalFigureDimensions[1].ToString();
            FinalFigWidthField.StringValue = AppSettings.FinalFigureDimensions[0].ToString();


            FinalFigParameterDisplayOptions.SetSelected(AppSettings.FinalFigureParameterDisplay.HasFlag(FinalFigureDisplayParameters.Model), 0);
            FinalFigParameterDisplayOptions.SetSelected(AppSettings.FinalFigureParameterDisplay.HasFlag(FinalFigureDisplayParameters.Fitted), 1);
            FinalFigParameterDisplayOptions.SetSelected(AppSettings.FinalFigureParameterDisplay.HasFlag(FinalFigureDisplayParameters.Derived), 2);
            FinalFigParameterDisplayOptions.SetSelected(AppSettings.FinalFigureParameterDisplay.HasFlag(FinalFigureDisplayParameters.Offset), 3);
            FinalFigParameterDisplayOptions.SetSelected(AppSettings.FinalFigureParameterDisplay.HasFlag(FinalFigureDisplayParameters.Temperature), 4);
            FinalFigParameterDisplayOptions.SetSelected(AppSettings.FinalFigureParameterDisplay.HasFlag(FinalFigureDisplayParameters.Concentrations), 5);
        }

        private void ExportPreferencesViewController_ShouldApplySettings(object sender, EventArgs e)
        {
            AppSettings.ExportSelectionMode = (Exporter.ExportDataSelection)(int)ExportSelectedControl.SelectedSegment;
            AppSettings.UnifyTimeAxisForExport = UnifyAxesControl.SelectedSegment == 0;
            AppSettings.ExportFitPointsWithPeaks = ExportSolutionPointsControl.State == NSCellStateValue.On;

            AppSettings.FinalFigureDimensions = new double[] { FinalFigWidthField.DoubleValue, FinalFigHeightField.DoubleValue };
            AppSettings.FinalFigureParameterDisplay = FinalFigureDisplayParameters.None;

            if (FinalFigParameterDisplayOptions.IsSelectedForSegment(0)) AppSettings.FinalFigureParameterDisplay |= FinalFigureDisplayParameters.Model;
            if (FinalFigParameterDisplayOptions.IsSelectedForSegment(1)) AppSettings.FinalFigureParameterDisplay |= FinalFigureDisplayParameters.Fitted;
            if (FinalFigParameterDisplayOptions.IsSelectedForSegment(2)) AppSettings.FinalFigureParameterDisplay |= FinalFigureDisplayParameters.Derived;
            if (FinalFigParameterDisplayOptions.IsSelectedForSegment(3)) AppSettings.FinalFigureParameterDisplay |= FinalFigureDisplayParameters.Offset;
            if (FinalFigParameterDisplayOptions.IsSelectedForSegment(4)) AppSettings.FinalFigureParameterDisplay |= FinalFigureDisplayParameters.Temperature;
            if (FinalFigParameterDisplayOptions.IsSelectedForSegment(5)) AppSettings.FinalFigureParameterDisplay |= FinalFigureDisplayParameters.Concentrations;
        }

        partial void Apply(NSObject sender)
        {
            ApplySettings();
            GeneralSettingsViewController.ApplySettings();
            FittingPreferencesViewController.ApplySettings();

            AppSettings.Save();

            Close(this);
        }

        partial void Close(NSObject sender)
        {
            this.View.Window.PerformClose(this);
            ShouldApplySettings -= ExportPreferencesViewController_ShouldApplySettings;
            this.Dispose();
        }
    }
}
