// This file has been autogenerated from a class added in the UI designer.

using System;

using Foundation;
using AppKit;

namespace AnalysisITC
{
	public partial class ToggleSelectTableView : NSTableView
	{
		public ToggleSelectTableView (IntPtr handle) : base (handle)
		{
		}

        public override void MouseDown(NSEvent theEvent)
        {
            var p = ConvertPointFromView(theEvent.LocationInWindow, null);
            var row = GetRow(p);
            var col = 0;

            // Click in empty area: keep current selection
            if (row < 0 || col < 0)
            {
                Window?.MakeFirstResponder(this);
                return;
            }

            // If the click is on a control (button, checkbox etc.), let it handle the click.
            if (ClickIsOnControl(row, col, p))
            {
                base.MouseDown(theEvent);
                return;
            }

            Window?.MakeFirstResponder(this);

            var idx = NSIndexSet.FromIndex((nint)row);

            if (SelectedRows.Contains((nuint)row))
                DeselectRow(row);
            else
                SelectRows(idx, byExtendingSelection: true);
        }

        bool ClickIsOnControl(nint row, nint col, CoreGraphics.CGPoint tablePoint)
        {
            var cellView = GetView((nint)col, row, makeIfNecessary: false);
            if (cellView == null) return false;

            var local = cellView.ConvertPointFromView(tablePoint, this);
            var hit = cellView.HitTest(local);
            for (var v = hit; v != null && v != cellView; v = v.Superview)
            {
                if (v is NSButton) return true;
            }
            return hit is NSButton;
        }
    }
}
